{% extends 'generic/object_retrieve.html' %}
{% load helpers %}
{% load static %}

{% block extra_styles %}
{{ block.super }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<style>
    .template-code-container {
        border: 1px solid var(--nb-border-color, #dee2e6);
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    
    .template-code-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 1rem;
        background: var(--nb-header-bg, #f8f9fa);
        border-bottom: 1px solid var(--nb-border-color, #dee2e6);
    }
    
    .template-code-content {
        background: #1e1e1e;
        max-height: 500px;
        overflow: auto;
    }
    
    .template-code-content pre {
        margin: 0;
        padding: 1rem;
    }
    
    .template-code-content code {
        font-family: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
        font-size: 13px;
        line-height: 1.5;
    }
    
    .version-timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .version-timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--nb-border-color, #dee2e6);
    }
    
    .version-entry {
        position: relative;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--nb-border-color, #dee2e6);
    }
    
    .version-entry:last-child {
        border-bottom: none;
    }
    
    .version-entry::before {
        content: '';
        position: absolute;
        left: -24px;
        top: 1rem;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--nb-primary, #007bff);
        border: 2px solid white;
        box-shadow: 0 0 0 2px var(--nb-primary, #007bff);
    }
    
    .version-entry.current::before {
        background: #28a745;
        box-shadow: 0 0 0 2px #28a745;
    }
    
    .version-meta {
        font-size: 0.85rem;
        color: var(--nb-text-muted, #6c757d);
    }
    
    .matching-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .matching-card {
        padding: 1rem;
        border: 1px solid var(--nb-border-color, #dee2e6);
        border-radius: 8px;
        background: var(--nb-card-bg, #fff);
    }
    
    .matching-card h6 {
        margin-bottom: 0.5rem;
        color: var(--nb-text-muted, #6c757d);
        font-size: 0.75rem;
        text-transform: uppercase;
    }
    
    .matching-card .value {
        font-size: 1.1rem;
        font-weight: 500;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
</style>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/jinja2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/django.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Apply syntax highlighting to template code
        document.querySelectorAll('pre code.language-jinja2').forEach((block) => {
            hljs.highlightElement(block);
        });
    });
    
    function copyTemplate() {
        const code = document.querySelector('.template-code-content code');
        if (code) {
            navigator.clipboard.writeText(code.textContent).then(() => {
                const btn = document.getElementById('copy-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="mdi mdi-check"></i> Copied!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            });
        }
    }
</script>
{% endblock %}

{% block content_left_page %}
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="mdi mdi-code-braces"></i> Template Content
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="template-code-container">
            <div class="template-code-header">
                <span class="text-muted">
                    <i class="mdi mdi-file-code"></i> 
                    {{ object.service.name }} Template
                    {% if object.software_version %}
                        ({{ object.software_version }})
                    {% endif %}
                </span>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="copy-btn" onclick="copyTemplate()">
                    <i class="mdi mdi-content-copy"></i> Copy
                </button>
            </div>
            <div class="template-code-content">
                <pre><code class="language-jinja2">{{ object.template_text }}</code></pre>
            </div>
        </div>
    </div>
</div>

{% if object.history.exists %}
<div class="card mt-3">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="mdi mdi-history"></i> Version History
        </h5>
    </div>
    <div class="card-body">
        <div class="version-timeline">
            {% for entry in object.history.all|slice:":10" %}
            <div class="version-entry {% if forloop.first %}current{% endif %}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>{% if forloop.first %}Current{% else %}Previous{% endif %} Version</strong>
                        <div class="version-meta">
                            Changed by {{ entry.changed_by }} on {{ entry.changed_at|date:"M d, Y H:i" }}
                        </div>
                        {% if entry.change_reason %}
                        <div class="text-muted small">{{ entry.change_reason }}</div>
                        {% endif %}
                    </div>
                    <a href="#" class="btn btn-sm btn-outline-secondary" 
                       data-bs-toggle="modal" 
                       data-bs-target="#history-modal-{{ forloop.counter }}">
                        <i class="mdi mdi-eye"></i> View
                    </a>
                </div>
            </div>
            
            <!-- Modal for viewing historical template -->
            <div class="modal fade" id="history-modal-{{ forloop.counter }}" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Template Version - {{ entry.changed_at|date:"M d, Y H:i" }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="template-code-content">
                                <pre><code class="language-jinja2">{{ entry.template_text }}</code></pre>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% if object.history.count > 10 %}
        <div class="text-center mt-3">
            <span class="text-muted">Showing 10 of {{ object.history.count }} history entries</span>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block content_right_page %}
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="mdi mdi-filter"></i> Matching Criteria
        </h5>
    </div>
    <div class="card-body">
        <div class="matching-info">
            <div class="matching-card">
                <h6>Service</h6>
                <div class="value">
                    <a href="{{ object.service.get_absolute_url }}">{{ object.service.name }}</a>
                </div>
            </div>
            
            {% if object.manufacturer %}
            <div class="matching-card">
                <h6>Manufacturer</h6>
                <div class="value">
                    <a href="{{ object.manufacturer.get_absolute_url }}">{{ object.manufacturer.name }}</a>
                </div>
            </div>
            {% endif %}
            
            {% if object.platform %}
            <div class="matching-card">
                <h6>Platform</h6>
                <div class="value">
                    <a href="{{ object.platform.get_absolute_url }}">{{ object.platform.name }}</a>
                </div>
            </div>
            {% endif %}
            
            {% if object.software_version %}
            <div class="matching-card">
                <h6>Software Version</h6>
                <div class="value">
                    <a href="{{ object.software_version.get_absolute_url }}">{{ object.software_version }}</a>
                </div>
            </div>
            {% endif %}
            
            {% if object.switch_profile %}
            <div class="matching-card">
                <h6>Switch Profile (Legacy)</h6>
                <div class="value">
                    <a href="{{ object.switch_profile.get_absolute_url }}">{{ object.switch_profile.name }}</a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="mdi mdi-information"></i> Template Details
        </h5>
    </div>
    <div class="card-body">
        <table class="table table-sm">
            <tbody>
                <tr>
                    <th scope="row">Status</th>
                    <td>
                        {% if object.is_active %}
                        <span class="status-badge badge bg-success">
                            <i class="mdi mdi-check-circle"></i> Active
                        </span>
                        {% else %}
                        <span class="status-badge badge bg-secondary">
                            <i class="mdi mdi-close-circle"></i> Inactive
                        </span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th scope="row">Version</th>
                    <td>{{ object.version }}</td>
                </tr>
                <tr>
                    <th scope="row">Effective Date</th>
                    <td>{{ object.effective_date|date:"M d, Y" }}</td>
                </tr>
                <tr>
                    <th scope="row">Validation</th>
                    <td>
                        {% if object.is_validated %}
                        <span class="badge bg-success">Valid</span>
                        <span class="text-muted small">{{ object.validation_message }}</span>
                        {% else %}
                        <span class="badge bg-warning">Not Validated</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th scope="row">Created By</th>
                    <td>{{ object.created_by|default:"-" }}</td>
                </tr>
                <tr>
                    <th scope="row">Created</th>
                    <td>{{ object.created|date:"M d, Y H:i" }}</td>
                </tr>
                <tr>
                    <th scope="row">Last Updated</th>
                    <td>{{ object.last_updated|date:"M d, Y H:i" }}</td>
                </tr>
                {% if object.superseded_by %}
                <tr>
                    <th scope="row">Superseded By</th>
                    <td>
                        <a href="{{ object.superseded_by.get_absolute_url }}">{{ object.superseded_by }}</a>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

{% if object.supersedes.exists %}
<div class="card mt-3">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="mdi mdi-arrow-up-bold"></i> Supersedes
        </h5>
    </div>
    <div class="card-body">
        <ul class="list-group list-group-flush">
            {% for old_template in object.supersedes.all %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <a href="{{ old_template.get_absolute_url }}">{{ old_template }}</a>
                <span class="text-muted small">v{{ old_template.version }}</span>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endif %}
{% endblock %}
