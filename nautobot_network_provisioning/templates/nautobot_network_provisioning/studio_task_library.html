{% extends "base.html" %}
{% load static %}

{% block head %}
{{ block.super }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-ocean.min.css">
<link rel="stylesheet" href="{% static 'nautobot_network_provisioning/css/studio_task_library.css' %}?v={% now "U" %}">
<style>
/* 
 * Studio Layout CSS - 2-Panel Task Library
 */
.studio-viewport {
    height: calc(100vh - 120px) !important;
    background: #0a0f1a !important;
    overflow: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
    display: flex;
}

.studio-shell {
    display: grid !important;
    grid-template-columns: 300px 1fr !important;
    width: 100% !important;
    height: 100% !important;
    background: #0a0f1a !important;
    color: #f8fafc !important;
    overflow: hidden !important;
}

/* Panel 1: Task List */
.studio-task-list-panel {
    background: #0f172a !important;
    border-right: 1px solid #334155 !important;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Panel 2: Task Editor */
.studio-task-editor-panel {
    background: #0a0f1a !important;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    padding: 20px;
}

.task-list-header {
    padding: 15px;
    border-bottom: 1px solid #334155;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.task-list-items {
    flex: 1;
    overflow-y: auto;
}

.task-item {
    padding: 12px 15px;
    border-bottom: 1px solid #1e293b;
    cursor: pointer;
    transition: background 0.2s;
}

.task-item:hover {
    background: #1e293b;
}

.task-item.active {
    background: #2563eb;
    color: white;
}

.editor-section {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid #1e293b;
}

.editor-section-title {
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    color: #94a3b8;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.form-group {
    margin-bottom: 15px;
}

.form-label {
    display: block;
    font-size: 0.85rem;
    color: #94a3b8;
    margin-bottom: 5px;
}

.form-control-studio {
    width: 100%;
    background: #1e293b;
    border: 1px solid #334155;
    color: #f8fafc;
    padding: 8px 12px;
    border-radius: 4px;
}

.form-control-studio:focus {
    outline: none;
    border-color: #2563eb;
}

.implementation-card {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn-studio {
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.85rem;
    cursor: pointer;
    border: none;
    font-weight: 600;
}

.btn-primary-studio {
    background: #2563eb;
    color: white;
}

.btn-secondary-studio {
    background: #334155;
    color: #f8fafc;
}

.btn-danger-studio {
    background: #991b1b;
    color: white;
}

.btn-success-studio {
    background: #166534;
    color: white;
}

/* CodeMirror height for JSON and Template */
.CodeMirror {
    height: 200px !important;
    border-radius: 4px;
}

/* Hide Nautobot footer */
.footer { display: none !important; }
</style>
{% endblock %}

{% block content %}
<div class="studio-viewport">
<div class="studio-shell" id="task-studio-root"
     data-api-root="/api/plugins/nautobot-network-provisioning/"
     data-csrf-token="{{ csrf_token }}"
     data-current-task-json='{{ object_json|safe }}'
     data-catalogs-json='{{ catalogs_json|default:"[]"|safe }}'
     data-tasks-json='{{ tasks_json|default:"[]"|safe }}'
     data-manufacturers-json='{{ manufacturers_json|default:"[]"|safe }}'
     data-platforms-json='{{ platforms_json|default:"[]"|safe }}'
     data-object-models-json='{{ object_models_json|default:"[]"|safe }}'>

    <!-- Panel 1: Task List -->
    <div class="studio-task-list-panel">
        <div class="task-list-header">
            <h3 style="font-size: 1rem; margin: 0;">Tasks</h3>
            <button class="btn-studio btn-primary-studio" id="btn-new-task">
                <i class="mdi mdi-plus"></i> New
            </button>
        </div>
        <div class="task-list-items" id="task-list-items">
            <!-- Rendered by JS -->
        </div>
    </div>

    <!-- Panel 2: Task Editor -->
    <div class="studio-task-editor-panel" id="task-editor-container">
        <!-- Initially empty or showing selected task -->
        <div id="editor-empty-state" class="text-center" style="margin-top: 100px; color: #64748b;">
            <i class="mdi mdi-lightning-bolt-outline" style="font-size: 4rem; opacity: 0.2;"></i>
            <p>Select a task to edit or create a new one.</p>
        </div>

        <div id="editor-content" class="d-none">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="editor-title" style="margin: 0; font-size: 1.5rem;">Edit Task</h2>
                <div>
                    <button class="btn-studio btn-danger-studio" id="btn-delete-task" style="margin-right: 10px;">Delete</button>
                    <button class="btn-studio btn-success-studio" id="btn-save-task">Save Task</button>
                </div>
            </div>

            <div class="editor-section">
                <div class="editor-section-title">General Information</div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label class="form-label">Task Name</label>
                            <input type="text" id="task-name" class="form-control-studio" placeholder="e.g. Configure NTP">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Catalog</label>
                            <select id="task-catalog" class="form-control-studio">
                                <option value="">-- None --</option>
                                <!-- Rendered by JS -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Target Model Context</label>
                            <select id="task-target-model" class="form-control-studio">
                                <option value="">-- None (Generic) --</option>
                                <!-- Rendered by JS -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="task-description" class="form-control-studio" rows="2"></textarea>
                </div>
            </div>

            <div class="editor-section">
                <div class="editor-section-title">
                    Input Schema (The Contract)
                    <small style="text-transform: none; font-weight: normal;">Define expected variables in JSON Schema format.</small>
                </div>
                <div id="schema-editor-container">
                    <textarea id="task-schema-editor"></textarea>
                </div>
            </div>

            <div class="editor-section">
                <div class="editor-section-title">
                    Platform Implementations
                    <button class="btn-studio btn-primary-studio" id="btn-add-implementation">
                        <i class="mdi mdi-plus"></i> Add Strategy
                    </button>
                </div>
                <div id="implementation-list">
                    <!-- Rendered by JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Task Modal -->
<div class="modal fade studio-modal" id="modal-new-task" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: #1e293b; color: #f8fafc; border: 1px solid #334155;">
            <div class="modal-header" style="border-bottom: 1px solid #334155;">
                <h5 class="modal-title">Create New Task</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Task Name</label>
                    <input type="text" id="new-task-name" class="form-control-studio" placeholder="e.g. Configure NTP Servers">
                </div>
                <div class="form-group">
                    <label class="form-label">Catalog (Optional)</label>
                    <select id="new-task-catalog" class="form-control-studio">
                        <option value="">-- None --</option>
                        <!-- Rendered by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="new-task-description" class="form-control-studio" rows="2" placeholder="Brief description of what this task does..."></textarea>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #334155;">
                <button type="button" class="btn-studio btn-secondary-studio" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-studio btn-success-studio" id="confirm-new-task">Create Task</button>
            </div>
        </div>
    </div>
</div>

<!-- Implementation Modal -->
<div class="modal fade studio-modal" id="modal-implementation" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="background: #1e293b; color: #f8fafc; border: 1px solid #334155;">
            <div class="modal-header" style="border-bottom: 1px solid #334155;">
                <h5 class="modal-title" id="impl-modal-title">Add Implementation</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="impl-id">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Manufacturer</label>
                            <select id="impl-manufacturer" class="form-control-studio">
                                <!-- Rendered by JS -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Platform (Optional)</label>
                            <select id="impl-platform" class="form-control-studio">
                                <option value="">-- Generic for Manufacturer --</option>
                                <!-- Rendered by JS -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Implementation Type</label>
                            <select id="impl-type" class="form-control-studio">
                                <option value="jinja2_config">Jinja2 Config Template</option>
                                <option value="api_call">API Call (JSON)</option>
                                <option value="python_code">Python Code</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Priority</label>
                            <input type="number" id="impl-priority" class="form-control-studio" value="100">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Software Version Constraint (e.g. >=15.0)</label>
                    <input type="text" id="impl-version" class="form-control-studio" placeholder="Optional semver constraint">
                </div>
                <div class="form-group">
                    <label class="form-label">Template / Code Content</label>
                    <textarea id="impl-content-editor"></textarea>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #334155;">
                <button type="button" class="btn-studio btn-secondary-studio" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-studio btn-danger-studio d-none" id="btn-delete-impl">Delete Strategy</button>
                <button type="button" class="btn-studio btn-success-studio" id="btn-save-impl">Save Strategy</button>
            </div>
        </div>
    </div>
</div>

</div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/jinja2/jinja2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="{% static 'nautobot_network_provisioning/js/studio_task_library.js' %}?v={% now "U" %}"></script>
<script>
    document.body.classList.add('studio-mode');
</script>
{% endblock %}
