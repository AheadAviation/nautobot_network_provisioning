{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-3">
    <div class="col">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'plugins:nautobot_network_provisioning:portal' %}">Portal</a></li>
          <li class="breadcrumb-item active">{{ request_form.name }}</li>
        </ol>
      </nav>
      <h1>{{ request_form.name }}</h1>
      <p class="text-muted">{{ request_form.description }}</p>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          <form method="post">
            {% csrf_token %}
            {% for spec in form.render_specs %}
              <div
                class="form-group mb-4"
                data-nnp-field="{{ spec.field_name }}"
                {% if spec.depends_on %}data-nnp-depends-on="{{ spec.depends_on }}"{% endif %}
                {% if spec.show_condition %}data-nnp-show-condition="{{ spec.show_condition|escape }}"{% endif %}
              >
                <label for="{{ spec.bound_field.id_for_label }}" class="form-label fw-bold">
                  {{ spec.label }}
                  {% if spec.required %}<span class="text-danger">*</span>{% endif %}
                </label>
                {{ spec.bound_field }}
                {% if spec.help_text %}<div class="form-text text-muted">{{ spec.help_text }}</div>{% endif %}
                {% if spec.bound_field.errors %}
                  <div class="invalid-feedback d-block">{{ spec.bound_field.errors }}</div>
                {% endif %}
              </div>
            {% endfor %}
            
            <div class="form-group mb-4 bg-light p-3 rounded">
               <label class="form-label fw-bold">Execution Options</label>
               <div class="form-check">
                  {{ form.__dry_run }}
                  <label class="form-check-label" for="{{ form.__dry_run.id_for_label }}">
                    {{ form.__dry_run.label }}
                  </label>
               </div>
               <div class="form-text">{{ form.__dry_run.help_text }}</div>
            </div>

            <hr>
            <div class="d-flex justify-content-between">
              <a href="{% url 'plugins:nautobot_network_provisioning:portal' %}" class="btn btn-outline-secondary">Cancel</a>
              <button type="submit" class="btn btn-success btn-lg">
                <i class="mdi mdi-send"></i> Submit Request
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    // Client-side visibility logic for low-code forms
    function getInputValue(inputEl) {
      if (!inputEl) return null;
      const type = (inputEl.getAttribute("type") || "").toLowerCase();
      if (type === "checkbox") return inputEl.checked;
      if (inputEl.tagName === "SELECT" && inputEl.multiple) {
        return Array.from(inputEl.selectedOptions || []).map((o) => o.value);
      }
      return inputEl.value;
    }

    function parseLiteral(lit) {
      const s = (lit || "").trim();
      if (s === "true") return true;
      if (s === "false") return false;
      if (s === "null" || s === "none") return null;
      if (/^-?\d+(\.\d+)?$/.test(s)) return Number(s);
      const m = s.match(/^['"](.+)['"]$/);
      if (m) return m[1];
      return s;
    }

    function evalShowCondition(expr, valuesByField) {
      const e = (expr || "").trim();
      if (!e) return true;
      let m = e.match(/^input\.([A-Za-z0-9_]+)\s*(==|!=)\s*(.+)$/);
      if (m) {
        const field = m[1];
        const op = m[2];
        const rhs = parseLiteral(m[3]);
        const lhs = valuesByField[field];
        if (op === "==") return String(lhs) === String(rhs);
        if (op === "!=") return String(lhs) !== String(rhs);
      }
      m = e.match(/^input\.([A-Za-z0-9_]+)$/);
      if (m) {
        const field = m[1];
        const v = valuesByField[field];
        if (Array.isArray(v)) return v.length > 0;
        return !!v;
      }
      return true;
    }

    function refreshVisibility() {
      const wrappers = Array.from(document.querySelectorAll("[data-nnp-field]"));
      const valuesByField = {};
      wrappers.forEach((w) => {
        const name = w.getAttribute("data-nnp-field");
        const input = w.querySelector(`[name="${name}"]`);
        valuesByField[name] = getInputValue(input);
      });

      wrappers.forEach((w) => {
        const name = w.getAttribute("data-nnp-field");
        const dependsOn = w.getAttribute("data-nnp-depends-on");
        const showCondition = w.getAttribute("data-nnp-show-condition");
        let visible = true;
        if (showCondition) {
          visible = evalShowCondition(showCondition, valuesByField);
        } else if (dependsOn) {
          const depVal = valuesByField[dependsOn];
          visible = Array.isArray(depVal) ? depVal.length > 0 : !!depVal;
        }
        w.style.display = visible ? "" : "none";
        const input = w.querySelector(`[name="${name}"]`);
        if (input) input.disabled = !visible;
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      document.addEventListener("change", function (e) {
        if (e && e.target && (e.target.name || e.target.id)) refreshVisibility();
      });
      refreshVisibility();
    });
  })();
</script>
{% endblock %}

