<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Designer</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    {% load static %}
    <style>
        :root {
            --bg-darkest: #0d0d0d;
            --bg-darker: #141414;
            --bg-dark: #1a1a1a;
            --bg-panel: #1e1e1e;
            --bg-surface: #252526;
            --bg-hover: #2d2d30;
            --bg-active: #094771;
            
            --border-subtle: #2d2d30;
            --border-default: #3e3e42;
            --border-accent: #007acc;
            
            --text-muted: #5a5a5a;
            --text-secondary: #858585;
            --text-primary: #cccccc;
            --text-bright: #e4e4e4;
            
            --accent-orange: #f48771;
            --accent-cyan: #4ec9b0;
            --accent-blue: #569cd6;
            --accent-purple: #c586c0;
            --accent-yellow: #dcdcaa;
            --accent-green: #22c55e;
            --accent-red: #f14c4c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-darkest);
            color: var(--text-primary);
        }

        #form-designer {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-default);
            height: 52px;
            flex-shrink: 0;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .toolbar-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-blue);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-name-input {
            background: var(--bg-dark);
            border: 1px solid var(--border-default);
            color: var(--text-bright);
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            min-width: 280px;
        }

        .form-name-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .btn {
            padding: 8px 16px;
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-accent);
        }

        .btn-primary {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #4a8ac2;
        }

        .btn-success {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: white;
        }

        .view-toggle {
            display: flex;
            background: var(--bg-dark);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            overflow: hidden;
        }

        .view-toggle-btn {
            padding: 6px 14px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-toggle-btn.active {
            background: var(--accent-blue);
            color: white;
        }

        /* Main Content */
        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Widget Toolbox Sidebar */
        .toolbox-sidebar {
            width: 260px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border-default);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .toolbox-header {
            padding: 14px 16px;
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border-default);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .toolbox-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .toolbox-section {
            margin-bottom: 20px;
        }

        .toolbox-section-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 10px;
            padding: 0 4px;
        }

        .widget-template {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.2s ease;
        }

        .widget-template:hover {
            border-color: var(--accent-blue);
            background: var(--bg-hover);
            transform: translateX(4px);
        }

        .widget-template:active {
            cursor: grabbing;
        }

        .widget-template-icon {
            font-size: 18px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background: var(--bg-dark);
            color: var(--accent-blue);
        }

        .widget-template-info {
            flex: 1;
        }

        .widget-template-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-bright);
        }

        .widget-template-desc {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Canvas Area */
        .canvas-area {
            flex: 1;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            overflow: auto;
        }

        .form-canvas {
            width: 100%;
            max-width: 720px;
            min-height: 500px;
            background: var(--bg-panel);
            border: 2px dashed var(--border-default);
            border-radius: 12px;
            padding: 32px;
            transition: border-color 0.2s;
        }

        .form-canvas.drag-over {
            border-color: var(--accent-blue);
            border-style: solid;
        }

        .form-canvas-header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-default);
        }

        .form-canvas-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: 4px;
        }

        .form-canvas-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .form-fields {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Form Field Widget on Canvas */
        .form-field-widget {
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .form-field-widget:hover {
            border-color: var(--accent-blue);
        }

        .form-field-widget.selected {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(86, 156, 214, 0.2);
        }

        .form-field-widget.dragging {
            opacity: 0.5;
        }

        .field-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-bright);
            margin-bottom: 8px;
        }

        .field-label .required {
            color: var(--accent-red);
            margin-left: 4px;
        }

        .field-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .field-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .field-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .field-checkbox input {
            width: 18px;
            height: 18px;
        }

        .field-help-text {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .field-drag-handle {
            position: absolute;
            top: 8px;
            right: 8px;
            color: var(--text-muted);
            cursor: grab;
            padding: 4px;
        }

        .field-delete-btn {
            position: absolute;
            top: 8px;
            right: 32px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            font-size: 14px;
        }

        .field-delete-btn:hover {
            color: var(--accent-red);
        }

        /* Empty Canvas State */
        .canvas-empty {
            text-align: center;
            padding: 60px;
            color: var(--text-secondary);
        }

        .canvas-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .canvas-empty h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .canvas-empty p {
            font-size: 13px;
            max-width: 300px;
            margin: 0 auto;
        }

        /* Properties Panel */
        .properties-panel {
            width: 300px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border-default);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .properties-panel.open {
            transform: translateX(0);
        }

        .properties-header {
            padding: 14px 16px;
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border-default);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .properties-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .properties-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
        }

        .properties-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .property-group {
            margin-bottom: 16px;
        }

        .property-label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .property-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .property-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .property-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .property-checkbox input {
            width: 16px;
            height: 16px;
        }

        .property-checkbox span {
            font-size: 13px;
            color: var(--text-primary);
        }

        /* Status Bar */
        .status-bar {
            padding: 8px 16px;
            background: var(--accent-blue);
            color: white;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div id="form-designer">
        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-left">
                <span class="toolbar-title">üìã Form Designer</span>
                <input type="text" class="form-name-input" id="form-name" 
                       value="{{ object.name|default:'New Request Form' }}" placeholder="Form name...">
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <div class="view-toggle">
                    <button class="view-toggle-btn active" data-view="design">Design</button>
                    <button class="view-toggle-btn" data-view="preview">Preview</button>
                </div>
                <button class="btn" onclick="FormDesigner.autoGenerate()">Auto-Generate</button>
                <button class="btn btn-primary" onclick="FormDesigner.save()">Save Form</button>
                <button class="btn btn-success" onclick="FormDesigner.publish()">Publish</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Widget Toolbox -->
            <div class="toolbox-sidebar">
                <div class="toolbox-header">Widget Library</div>
                <div class="toolbox-content">
                    <div class="toolbox-section">
                        <div class="toolbox-section-title">Basic Inputs</div>
                        <div class="widget-template" data-type="text" draggable="true">
                            <div class="widget-template-icon">Aa</div>
                            <div class="widget-template-info">
                                <div class="widget-template-name">Text Input</div>
                                <div class="widget-template-desc">Single line text</div>
                            </div>
                        </div>
                        <div class="widget-template" data-type="textarea" draggable="true">
                            <div class="widget-template-icon">¬∂</div>
                            <div class="widget-template-info">
                                <div class="widget-template-name">Text Area</div>
                                <div class="widget-template-desc">Multi-line text</div>
                            </div>
                        </div>
                        <div class="widget-template" data-type="number" draggable="true">
                            <div class="widget-template-icon">#</div>
                            <div class="widget-template-info">
                                <div class="widget-template-name">Number</div>
                                <div class="widget-template-desc">Numeric input</div>
                            </div>
                        </div>
                        <div class="widget-template" data-type="select" draggable="true">
                            <div class="widget-template-icon">‚ñº</div>
                            <div class="widget-template-info">
                                <div class="widget-template-name">Dropdown</div>
                                <div class="widget-template-desc">Single choice</div>
                            </div>
                        </div>
                        <div class="widget-template" data-type="checkbox" draggable="true">
                            <div class="widget-template-icon">‚òë</div>
                            <div class="widget-template-info">
                                <div class="widget-template-name">Checkbox</div>
                                <div class="widget-template-desc">Boolean toggle</div>
                            </div>
                        </div>
                    </div>

                    <div class="toolbox-section">
                        <div class="toolbox-section-title">Nautobot Smart</div>
                        <div class="widget-template" data-type="device-selector" draggable="true">
                            <div class="widget-template-icon">üñ•</div>
                            <div class="widget-template-info">
                                <div class="widget-template-name">Device Selector</div>
                                <div class="widget-template-desc">Search Nautobot devices</div>
                            </div>
                        </div>
                        <div class="widget-template" data-type="location-selector" draggable="true">
                            <div class="widget-template-icon">üìç</div>
                            <div class="widget-template-info">
                                <div class="widget-template-name">Location Selector</div>
                                <div class="widget-template-desc">Select sites/locations</div>
                            </div>
                        </div>
                        <div class="widget-template" data-type="vlan-selector" draggable="true">
                            <div class="widget-template-icon">üîå</div>
                            <div class="widget-template-info">
                                <div class="widget-template-name">VLAN Selector</div>
                                <div class="widget-template-desc">Select VLANs</div>
                            </div>
                        </div>
                        <div class="widget-template" data-type="interface-selector" draggable="true">
                            <div class="widget-template-icon">‚åò</div>
                            <div class="widget-template-info">
                                <div class="widget-template-name">Interface Selector</div>
                                <div class="widget-template-desc">Device interfaces</div>
                            </div>
                        </div>
                    </div>

                    <div class="toolbox-section">
                        <div class="toolbox-section-title">Layout</div>
                        <div class="widget-template" data-type="section" draggable="true">
                            <div class="widget-template-icon">‚ñ¨</div>
                            <div class="widget-template-info">
                                <div class="widget-template-name">Section Header</div>
                                <div class="widget-template-desc">Group fields</div>
                            </div>
                        </div>
                        <div class="widget-template" data-type="divider" draggable="true">
                            <div class="widget-template-icon">‚Äî</div>
                            <div class="widget-template-info">
                                <div class="widget-template-name">Divider</div>
                                <div class="widget-template-desc">Visual separator</div>
                            </div>
                        </div>
                        <div class="widget-template" data-type="help-text" draggable="true">
                            <div class="widget-template-icon">‚Ñπ</div>
                            <div class="widget-template-info">
                                <div class="widget-template-name">Help Text</div>
                                <div class="widget-template-desc">Info block</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Canvas Area -->
            <div class="canvas-area">
                <div class="form-canvas" id="form-canvas">
                    <div class="form-canvas-header">
                        <div class="form-canvas-title" id="canvas-title">Request Form</div>
                        <div class="form-canvas-subtitle" id="canvas-subtitle">Fill out this form to submit your request</div>
                    </div>
                    <div class="form-fields" id="form-fields">
                        <!-- Fields added here -->
                    </div>
                    <div class="canvas-empty" id="empty-state">
                        <div class="canvas-empty-icon">üìã</div>
                        <h3>Drag widgets here</h3>
                        <p>Build your form by dragging widgets from the library on the left</p>
                    </div>
                </div>
            </div>

            <!-- Properties Panel -->
            <div class="properties-panel" id="properties-panel">
                <div class="properties-header">
                    <span class="properties-title">Field Properties</span>
                    <button class="properties-close" onclick="FormDesigner.closeProperties()">√ó</button>
                </div>
                <div class="properties-content">
                    <div class="property-group">
                        <label class="property-label">Field Label</label>
                        <input type="text" class="property-input" id="prop-label" placeholder="Enter label">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Field Name (Variable)</label>
                        <input type="text" class="property-input" id="prop-name" placeholder="e.g., vlan_id">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Placeholder</label>
                        <input type="text" class="property-input" id="prop-placeholder" placeholder="Enter placeholder">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Help Text</label>
                        <input type="text" class="property-input" id="prop-help" placeholder="Help text for users">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Default Value</label>
                        <input type="text" class="property-input" id="prop-default" placeholder="Default value">
                    </div>
                    <div class="property-group">
                        <label class="property-checkbox">
                            <input type="checkbox" id="prop-required">
                            <span>Required field</span>
                        </label>
                    </div>
                    <div class="property-group" id="choices-section" style="display: none;">
                        <label class="property-label">Choices (one per line)</label>
                        <textarea class="property-input" id="prop-choices" rows="5" placeholder="Option 1&#10;Option 2&#10;Option 3"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <span id="status-text">Ready</span>
            <span id="field-count">0 fields</span>
        </div>
    </div>

    <script>
        const FormDesigner = {
            fields: [],
            selectedField: null,
            nextFieldId: 1,
            apiRoot: '/plugins/network-provisioning/api/',
            csrfToken: "{{ csrf_token }}",
            formId: "{{ object.pk|default:'' }}",
            workflowId: "{{ object.workflow_id|default:'' }}",

            init: function() {
                this.loadForm();
                this.setupDragDrop();
                this.setupViewToggle();
                this.updateStatus('Form Designer ready');
            },

            loadForm: function() {
                const formJson = {{ form_json|default:"{}"|safe }};
                if (formJson.field_definition) {
                    this.fields = formJson.field_definition.fields || [];
                    this.renderFields();
                    this.hideEmptyState();
                }
            },

            setupDragDrop: function() {
                document.querySelectorAll('.widget-template').forEach(template => {
                    template.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('widget-type', template.dataset.type);
                        e.dataTransfer.effectAllowed = 'copy';
                    });
                });

                const canvas = document.getElementById('form-canvas');
                canvas.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    canvas.classList.add('drag-over');
                });

                canvas.addEventListener('dragleave', () => {
                    canvas.classList.remove('drag-over');
                });

                canvas.addEventListener('drop', (e) => {
                    e.preventDefault();
                    canvas.classList.remove('drag-over');
                    
                    const type = e.dataTransfer.getData('widget-type');
                    if (type) {
                        this.addField(type);
                    }
                });
            },

            setupViewToggle: function() {
                document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        // Toggle design/preview mode
                    });
                });
            },

            addField: function(type) {
                const field = {
                    id: `field-${this.nextFieldId++}`,
                    type: type,
                    label: this.getDefaultLabel(type),
                    name: `field_${this.fields.length + 1}`,
                    placeholder: '',
                    helpText: '',
                    required: false,
                    defaultValue: '',
                    choices: []
                };

                this.fields.push(field);
                this.renderField(field);
                this.hideEmptyState();
                this.updateFieldCount();
                this.updateStatus(`Added ${type} field`);
            },

            getDefaultLabel: function(type) {
                const labels = {
                    'text': 'Text Field',
                    'textarea': 'Text Area',
                    'number': 'Number',
                    'select': 'Select Option',
                    'checkbox': 'Checkbox',
                    'device-selector': 'Select Device',
                    'location-selector': 'Select Location',
                    'vlan-selector': 'Select VLAN',
                    'interface-selector': 'Select Interface',
                    'section': 'Section Title',
                    'divider': '',
                    'help-text': 'Information'
                };
                return labels[type] || 'New Field';
            },

            renderFields: function() {
                const container = document.getElementById('form-fields');
                container.innerHTML = '';
                this.fields.forEach(field => this.renderField(field));
            },

            renderField: function(field) {
                const container = document.getElementById('form-fields');
                const el = document.createElement('div');
                el.className = 'form-field-widget';
                el.id = field.id;
                el.dataset.type = field.type;

                let inputHtml = '';
                switch (field.type) {
                    case 'text':
                    case 'number':
                    case 'device-selector':
                    case 'location-selector':
                    case 'vlan-selector':
                    case 'interface-selector':
                        inputHtml = `<input type="${field.type === 'number' ? 'number' : 'text'}" class="field-input" placeholder="${field.placeholder || 'Enter value...'}" disabled>`;
                        break;
                    case 'textarea':
                        inputHtml = `<textarea class="field-input" placeholder="${field.placeholder || 'Enter text...'}" rows="3" disabled></textarea>`;
                        break;
                    case 'select':
                        inputHtml = `<select class="field-select" disabled><option>Select...</option></select>`;
                        break;
                    case 'checkbox':
                        inputHtml = `<div class="field-checkbox"><input type="checkbox" disabled><span>${field.label}</span></div>`;
                        break;
                    case 'section':
                        inputHtml = `<div style="font-size: 16px; font-weight: 600; color: var(--accent-blue); padding-bottom: 8px; border-bottom: 2px solid var(--accent-blue);">${field.label}</div>`;
                        break;
                    case 'divider':
                        inputHtml = `<hr style="border: none; border-top: 1px solid var(--border-default);">`;
                        break;
                    case 'help-text':
                        inputHtml = `<div style="background: rgba(86, 156, 214, 0.1); padding: 12px; border-radius: 6px; font-size: 12px; color: var(--accent-blue);">${field.label}</div>`;
                        break;
                }

                const showLabel = !['checkbox', 'section', 'divider', 'help-text'].includes(field.type);
                
                el.innerHTML = `
                    <button class="field-delete-btn" onclick="FormDesigner.deleteField('${field.id}')" title="Delete">√ó</button>
                    <span class="field-drag-handle">‚ãÆ‚ãÆ</span>
                    ${showLabel ? `<label class="field-label">${field.label}${field.required ? '<span class="required">*</span>' : ''}</label>` : ''}
                    ${inputHtml}
                    ${field.helpText ? `<div class="field-help-text">${field.helpText}</div>` : ''}
                `;

                el.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('field-delete-btn')) {
                        this.selectField(field.id);
                    }
                });

                container.appendChild(el);
            },

            selectField: function(fieldId) {
                document.querySelectorAll('.form-field-widget').forEach(f => f.classList.remove('selected'));
                
                const field = this.fields.find(f => f.id === fieldId);
                if (!field) return;

                this.selectedField = field;
                document.getElementById(fieldId).classList.add('selected');
                this.openProperties(field);
            },

            openProperties: function(field) {
                const panel = document.getElementById('properties-panel');
                panel.classList.add('open');

                document.getElementById('prop-label').value = field.label || '';
                document.getElementById('prop-name').value = field.name || '';
                document.getElementById('prop-placeholder').value = field.placeholder || '';
                document.getElementById('prop-help').value = field.helpText || '';
                document.getElementById('prop-default').value = field.defaultValue || '';
                document.getElementById('prop-required').checked = field.required;

                // Show/hide choices section
                document.getElementById('choices-section').style.display = 
                    field.type === 'select' ? 'block' : 'none';
                if (field.type === 'select') {
                    document.getElementById('prop-choices').value = (field.choices || []).join('\n');
                }

                // Bind change events
                this.bindPropertyEvents(field);
            },

            bindPropertyEvents: function(field) {
                const updateField = () => {
                    field.label = document.getElementById('prop-label').value;
                    field.name = document.getElementById('prop-name').value;
                    field.placeholder = document.getElementById('prop-placeholder').value;
                    field.helpText = document.getElementById('prop-help').value;
                    field.defaultValue = document.getElementById('prop-default').value;
                    field.required = document.getElementById('prop-required').checked;
                    
                    if (field.type === 'select') {
                        field.choices = document.getElementById('prop-choices').value.split('\n').filter(c => c.trim());
                    }
                    
                    this.renderFields();
                    this.selectField(field.id);
                };

                document.querySelectorAll('.properties-content input, .properties-content textarea').forEach(input => {
                    input.onchange = updateField;
                });
            },

            closeProperties: function() {
                document.getElementById('properties-panel').classList.remove('open');
                document.querySelectorAll('.form-field-widget').forEach(f => f.classList.remove('selected'));
                this.selectedField = null;
            },

            deleteField: function(fieldId) {
                this.fields = this.fields.filter(f => f.id !== fieldId);
                const el = document.getElementById(fieldId);
                if (el) el.remove();
                
                if (this.fields.length === 0) {
                    this.showEmptyState();
                }
                this.updateFieldCount();
                this.closeProperties();
                this.updateStatus('Field deleted');
            },

            hideEmptyState: function() {
                document.getElementById('empty-state').style.display = 'none';
            },

            showEmptyState: function() {
                document.getElementById('empty-state').style.display = 'block';
            },

            updateFieldCount: function() {
                document.getElementById('field-count').textContent = `${this.fields.length} fields`;
            },

            updateStatus: function(text) {
                document.getElementById('status-text').textContent = text;
            },

            autoGenerate: function() {
                // TODO: Load workflow inputs and auto-generate fields
                this.updateStatus('Auto-generate requires a linked workflow');
            },

            save: async function() {
                const name = document.getElementById('form-name').value.trim();
                if (!name) {
                    this.updateStatus('‚ö†Ô∏è Please enter a form name');
                    return;
                }

                const fieldDefinition = {
                    fields: this.fields
                };

                const payload = {
                    name: name,
                    slug: name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, ''),
                    field_definition: fieldDefinition
                };

                // Add workflow if set
                if (this.workflowId) {
                    payload.workflow = this.workflowId;
                }

                try {
                    const method = this.formId ? 'PATCH' : 'POST';
                    const url = this.formId 
                        ? `${this.apiRoot}request-forms/${this.formId}/`
                        : `${this.apiRoot}request-forms/`;

                    const res = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.csrfToken
                        },
                        body: JSON.stringify(payload)
                    });

                    if (res.ok) {
                        const data = await res.json();
                        this.formId = data.id;
                        this.updateStatus('‚úì Form saved successfully');
                    } else {
                        const error = await res.json();
                        this.updateStatus(`‚ö†Ô∏è Save failed: ${JSON.stringify(error)}`);
                    }
                } catch (err) {
                    this.updateStatus(`‚ö†Ô∏è Save failed: ${err.message}`);
                }
            },

            publish: function() {
                if (!this.formId) {
                    this.updateStatus('‚ö†Ô∏è Please save the form first');
                    return;
                }
                this.updateStatus('‚úì Form published to Portal');
            }
        };

        document.addEventListener('DOMContentLoaded', () => FormDesigner.init());
    </script>
</body>
</html>

