{% extends "generic/object_retrieve.html" %}
{% load static %}

{% block content_left_page %}
    <div class="panel panel-default">
        <div class="panel-heading">
            <strong>Mission Control</strong>
        </div>
        <div class="panel-body text-center">
            {% if object.status.name|lower == "pending" %}
                <form method="post" action="{% url 'plugins:nautobot_network_provisioning:execution_run' pk=object.pk %}">
                    {% csrf_token %}
                    <button type="submit" name="action" value="dry_run" class="btn btn-info btn-block">
                        <i class="mdi mdi-eye"></i> Preview (Dry Run)
                    </button>
                    <button type="submit" name="action" value="apply" class="btn btn-primary btn-block">
                        <i class="mdi mdi-play"></i> Execute (Apply)
                    </button>
                </form>
            {% elif object.status.name|lower == "failed" %}
                 <form method="post" action="{% url 'plugins:nautobot_network_provisioning:execution_run' pk=object.pk %}">
                    {% csrf_token %}
                    <button type="submit" name="action" value="apply" class="btn btn-warning btn-block">
                        <i class="mdi mdi-refresh"></i> Retry Execution
                    </button>
                </form>
            {% else %}
                <div class="alert alert-secondary">Execution {{ object.status }}</div>
            {% endif %}
        </div>
        <table class="table table-hover panel-body attr-table">
            <tr>
                <td>Status</td>
                <td>
                    <span class="label label-primary">{{ object.status }}</span>
                </td>
            </tr>
            <tr>
                <td>Workflow</td>
                <td><strong>{{ object.workflow.name }}</strong></td>
            </tr>
            <tr>
                <td>User</td>
                <td>{{ object.user|default:"System" }}</td>
            </tr>
            <tr>
                <td>Started</td>
                <td>{{ object.start_time|date:"H:i:s" }}</td>
            </tr>
            <tr>
                <td>Finished</td>
                <td>{{ object.end_time|date:"H:i:s"|default:"--" }}</td>
            </tr>
        </table>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading">
            <strong>Input Context</strong>
        </div>
        <div class="panel-body">
            <pre style="font-size: 10px; background: #f8f9fa;">{{ object.input_data }}</pre>
        </div>
    </div>
{% endblock %}

{% block content_full_width_page %}
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <strong>Step-by-Step Execution Trace</strong>
                </div>
                <div class="panel-body" style="padding: 0;">
                    <div class="execution-steps">
                        {% for step in object.steps.all %}
                            <div class="execution-step-container" style="border-bottom: 1px solid #eee; padding: 15px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <div>
                                        <span class="badge bg-secondary">{{ forloop.counter }}</span>
                                        <strong>{{ step.task.name }}</strong>
                                        <span class="label label-success">{{ step.status }}</span>
                                    </div>
                                    <div class="text-muted small">
                                        {{ step.start_time|date:"H:i:s" }}
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <pre style="background: #1e1e1e; color: #d4d4d4; padding: 10px; font-size: 12px;">{{ step.output|default:"[System] No output recorded." }}</pre>
                                </div>
                                {% if step.error_message %}
                                    <div class="alert alert-danger mt-2">
                                        {{ step.error_message }}
                                    </div>
                                {% endif %}
                            </div>
                        {% empty %}
                            <div class="alert alert-info m-4">No steps recorded for this execution yet.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

