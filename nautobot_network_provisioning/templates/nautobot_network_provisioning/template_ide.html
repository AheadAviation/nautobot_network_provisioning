{% extends 'base.html' %}
{% load static %}

{% block header %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
    <style>
        .ide-full-screen {
            height: calc(100vh - 150px);
            display: flex;
            flex-direction: column;
        }
        .ide-main-row {
            flex-grow: 1;
            overflow: hidden;
        }
        .ide-editor-column, .ide-preview-column {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .ide-pane-header {
            padding: 5px 10px;
            background-color: var(--nautobot-bg-light);
            border: 1px solid var(--nautobot-border-color);
            border-bottom: none;
            font-size: 0.85rem;
        }
        .ide-editor-container {
            border: 1px solid var(--nautobot-border-color);
            flex-grow: 1;
            position: relative;
        }
        .ide-variables-container {
            height: 30%;
            flex-grow: 0;
            min-height: 150px;
        }
        .ide-preview-container {
            flex-grow: 1;
            background-color: var(--nautobot-bg-base);
            overflow-y: auto;
        }
        .CodeMirror {
            height: 100%;
            font-family: var(--bs-font-monospace);
            font-size: 14px;
        }
        /* Theme awareness helper */
        body.theme-dark .ide-pane-header {
            background-color: #2d2d2d;
            border-color: #444;
        }
        body.theme-dark .ide-editor-container {
            border-color: #444;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid ide-full-screen">
    <!-- Toolbar -->
    <div class="row bg-body-tertiary border-bottom py-2 mb-3 align-items-center">
        <div class="col-md-4">
            <h4 class="mb-0">Template IDE</h4>
            {% if implementation %}
                <small class="text-muted">Editing: <a href="{{ implementation.get_absolute_url }}">{{ implementation.name }}</a></small>
            {% endif %}
        </div>
        <div class="col-md-8 text-end">
            <div class="btn-group">
                {% if implementation %}
                <a href="{{ implementation.task.get_absolute_url }}" class="btn btn-sm btn-outline-secondary">
                    <i class="mdi mdi-arrow-left"></i> Back to Task
                </a>
                {% endif %}
                <button id="btn-load-device" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#loadDeviceModal" title="Load context from a Device">
                    <i class="mdi mdi-router-network"></i> Load Device
                </button>
                <button id="btn-load-graphql" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#loadGraphQLModal" title="Load context from GraphQL">
                    <i class="mdi mdi-graphql"></i> Load GraphQL
                </button>
            </div>
            <div class="btn-group ms-2">
                <button id="btn-format" class="btn btn-sm btn-outline-secondary" onclick="Jinja2Editor.formatIDE()">
                    <i class="mdi mdi-format-align-left"></i> Format
                </button>
                <button id="btn-validate" class="btn btn-sm btn-outline-secondary" onclick="Jinja2Editor.validateIDE()">
                    <i class="mdi mdi-check-circle-outline"></i> Validate
                </button>
                <button id="btn-preview" class="btn btn-sm btn-primary" onclick="Jinja2Editor.runPreviewIDE()">
                    <i class="mdi mdi-play"></i> Run Preview
                </button>
            </div>
            {% if implementation %}
            <button id="btn-save" class="btn btn-sm btn-success ms-2" onclick="Jinja2Editor.saveIDE()">
                <i class="mdi mdi-content-save"></i> Save
            </button>
            {% endif %}
        </div>
    </div>

    <div class="row ide-main-row g-3">
        <!-- Left Side: Editors -->
        <div class="col-md-6 ide-editor-column">
            <div class="ide-pane-header">
                <strong>Template (Jinja2)</strong>
            </div>
            <div class="ide-editor-container mb-3">
                <textarea id="template-editor">{{ template_content }}</textarea>
            </div>
            
            <div class="ide-pane-header">
                <strong>Variables (JSON)</strong>
            </div>
            <div class="ide-editor-container ide-variables-container">
                <textarea id="variables-editor">{{ variables_json }}</textarea>
            </div>
        </div>

        <!-- Right Side: Preview -->
        <div class="col-md-6 ide-preview-column">
            <div class="ide-pane-header d-flex justify-content-between align-items-center">
                <strong>Output Preview</strong>
                <span id="preview-status" class="badge bg-secondary">Idle</span>
            </div>
            <div class="ide-preview-container border p-0">
                <div id="preview-output" class="p-3 font-monospace" style="white-space: pre-wrap; height: 100%;">Rendered output will appear here...</div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="loadDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Load Context from Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">Select a device to fetch its standardized rendering context (interfaces, facts, etc.).</p>
                <div class="mb-3">
                    <label class="form-label">Device</label>
                    <select id="device-select" class="form-select nautobot-select2-api" data-api-url="/api/dcim/devices/"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirm-load-device" class="btn btn-primary" onclick="Jinja2Editor.loadDeviceContext()">Load Context</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="loadGraphQLModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Run GraphQL Query</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">The result of this query will be merged into your "Variables" pane.</p>
                <div class="mb-3">
                    <label class="form-label">Query</label>
                    <textarea id="graphql-query-text" class="form-control font-monospace" rows="10">query {
  devices(limit: 1) {
    name
    primary_ip4 {
      address
    }
  }
}</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirm-load-graphql" class="btn btn-primary" onclick="Jinja2Editor.runGraphQLQuery()">Run & Load Result</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/jinja2/jinja2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/display/placeholder.min.js"></script>
    <script src="{% static 'nautobot_network_provisioning/js/template-editor.js' %}"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof Jinja2Editor !== 'undefined' && Jinja2Editor.initIDE) {
                Jinja2Editor.initIDE({
                    templateEditorId: 'template-editor',
                    variablesEditorId: 'variables-editor',
                    previewOutputId: 'preview-output',
                    previewStatusId: 'preview-status',
                    {% if implementation %}
                    implementationId: '{{ implementation.pk }}',
                    {% endif %}
                    apiUrl: '/api/plugins/network-provisioning/',
                    previewUrl: '/api/plugins/network-provisioning/template-preview/',
                    deviceContextUrl: '/api/plugins/network-provisioning/device-context/',
                    graphqlUrl: '/api/graphql/'
                });
            }
        });
    </script>
{% endblock %}
